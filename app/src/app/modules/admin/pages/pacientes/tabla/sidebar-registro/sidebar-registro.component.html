<div
    class="fixed inset-0 z-50 flex justify-end bg-black/40 backdrop-blur-sm px-4 py-6 md:p-8"
    (click)="cerrarSidebar()"
   
>
    <div
        class="sidebar-panel relative flex h-full w-160 max-w-full flex-col overflow-hidden rounded-2xl bg-white shadow-2xl"
        (click)="$event.stopPropagation()"
    >
        <div class="flex items-center justify-between border-b border-gray-200 bg-gray-50/60 px-6 py-4">
            <div>
                <p class="text-xs font-semibold uppercase tracking-wide text-blue-600">
                    Nuevo Paciente
                </p>
                <h2 class="text-xl font-bold text-gray-900">Completa los datos requeridos</h2>
            </div>
            <button
                (click)="cerrarSidebar()"
                class="rounded-full p-2 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-700"
                type="button"
            >
                <mat-icon svgIcon="feather:x" class="h-5 w-5"></mat-icon>
            </button>
        </div>

        <div class="border-b border-gray-200 bg-white px-6 py-4">
            <div class="flex items-center justify-between">
                @for (step of steps; track step.number) {
                    <div class="flex flex-col items-center gap-2">
                        <div
                            class="flex h-8 w-8 items-center justify-center rounded-full border-2 transition-colors duration-200"
                            [ngClass]="{
                                'border-blue-600 bg-blue-600 text-white': currentStep >= step.number,
                                'border-gray-300 text-gray-400': currentStep < step.number
                            }"
                        >
                            @if (currentStep > step.number) {
                                <mat-icon class="icon-size-4" svgIcon="feather:check"></mat-icon>
                            } @else {
                                <span class="text-xs font-bold">{{ step.number }}</span>
                            }
                        </div>
                        <span
                            class="text-[10px] font-medium uppercase"
                            [ngClass]="currentStep >= step.number ? 'text-blue-600' : 'text-gray-400'"
                        >
                            {{ step.title }}
                        </span>
                    </div>
                    @if ($index !== steps.length - 1) {
                        <div class="mx-2 mb-4 flex-1 border-t border-gray-200"></div>
                    }
                }
            </div>
        </div>

        <div class="custom-scrollbar flex-1 overflow-y-auto px-6 py-5">
            <form [formGroup]="patientForm" class="space-y-6">
                <!-- STEP 1: REGISTRO -->
                @if (currentStep === 1) {
                    <div class="animate-in fade-in slide-in-from-right-4 duration-300 space-y-4 rounded-xl bg-white p-6 shadow-sm border border-gray-100">
                        <div>
                            <label class="mb-1.5 block text-sm font-semibold text-gray-700">Cedula <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <mat-icon class="absolute left-3 top-1/2 icon-size-5 -translate-y-1/2 text-gray-400" svgIcon="heroicons_outline:identification"></mat-icon>
                                <input formControlName="dni" class="w-full rounded-lg border border-gray-200 bg-gray-50 py-2.5 pl-10 pr-4 text-gray-900 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-100 transition-all placeholder:text-gray-400">
                            </div>
                            @if(patientForm.get('dni')?.hasError('required') && patientForm.get('dni')?.touched) {
                                <p class="mt-1 text-xs text-red-500">Campo requerido</p>
                            }
                        </div>
                        <div>
                            <label class="mb-1.5 block text-sm font-semibold text-gray-700">Nombre Completo <span class="text-red-500">*</span></label>
                            <div class="relative">
                                 <mat-icon class="absolute left-3 top-1/2 icon-size-5 -translate-y-1/2 text-gray-400" svgIcon="heroicons_outline:user"></mat-icon>
                                 <input formControlName="name" class="w-full rounded-lg border border-gray-200 bg-gray-50 py-2.5 pl-10 pr-4 text-gray-900 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-100 transition-all placeholder:text-gray-400">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="mb-1.5 block text-sm font-semibold text-gray-700">Teléfono</label>
                                <input formControlName="phone" class="w-full rounded-lg border border-gray-200 bg-gray-50 py-2.5 px-4 text-gray-900 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-100 transition-all">
                                @if(patientForm.get('phone')?.touched && patientForm.get('phone')?.invalid) {
                                    <p class="mt-1 text-xs text-red-500">Teléfono requerido (mín. 10 dígitos)</p>
                                }
                            </div>
                            <div>
                                <label class="mb-1.5 block text-sm font-semibold text-gray-700">Fecha Nac.</label>
                                <input type="date" formControlName="date_of_birth" class="w-full rounded-lg border border-gray-200 bg-gray-50 py-2.5 px-4 text-gray-900 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-100 transition-all">
                                @if(patientForm.get('date_of_birth')?.touched && patientForm.get('date_of_birth')?.invalid) {
                                    <p class="mt-1 text-xs text-red-500">Fecha de nacimiento requerida</p>
                                }
                            </div>
                        </div>
                        <div>
                            <label class="mb-1.5 block text-sm font-semibold text-gray-700">Email</label>
                            <input type="email" formControlName="email" class="w-full rounded-lg border border-gray-200 bg-gray-50 py-2.5 px-4 text-gray-900 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-100 transition-all">
                            @if(patientForm.get('email')?.touched && patientForm.get('email')?.invalid) {
                                <p class="mt-1 text-xs text-red-500">Email válido requerido</p>
                            }
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="mb-1.5 block text-sm font-semibold text-gray-700">Seguro</label>
                                <input formControlName="insurance" class="w-full rounded-lg border border-gray-200 bg-gray-50 py-2.5 px-4 text-gray-900 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-100 transition-all">
                            </div>
                            <div>
                                <label class="mb-1.5 block text-sm font-semibold text-gray-700">Póliza</label>
                                <input formControlName="insurance_id" class="w-full rounded-lg border border-gray-200 bg-gray-50 py-2.5 px-4 text-gray-900 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-100 transition-all">
                            </div>
                        </div>
                    </div>
                }

                <!-- STEP 2: HABITOS -->
                @if (currentStep === 2) {
                    <div class="animate-in fade-in slide-in-from-right-4 duration-300 space-y-4 rounded-xl bg-white p-6 shadow-sm border border-gray-100" formGroupName="habits">
                         <div class="space-y-4">
                            <label class="flex items-center gap-3 rounded-lg border border-gray-200 p-4 transition-colors hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" formControlName="smoking" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-600">
                                <div class="flex-1">
                                    <span class="block font-medium text-gray-900">Fumador</span>
                                    <span class="text-xs text-gray-500">¿El paciente fuma regularmente?</span>
                                </div>
                            </label>
                            
                            <label class="flex items-center gap-3 rounded-lg border border-gray-200 p-4 transition-colors hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" formControlName="alcohol" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-600">
                                <div class="flex-1">
                                    <span class="block font-medium text-gray-900">Consumo de Alcohol</span>
                                    <span class="text-xs text-gray-500">¿Consume alcohol frecuentemente?</span>
                                </div>
                            </label>

                            <label class="flex items-center gap-3 rounded-lg border border-gray-200 p-4 transition-colors hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" formControlName="bruxism" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-600">
                                <div class="flex-1">
                                    <span class="block font-medium text-gray-900">Bruxismo</span>
                                    <span class="text-xs text-gray-500">¿Rechina los dientes al dormir?</span>
                                </div>
                            </label>
                         </div>

                         <div class="pt-4 border-t border-gray-100">
                             <label class="mb-2 block text-sm font-semibold text-gray-700">Frecuencia de cepillado (veces al día)</label>
                             <div class="grid grid-cols-3 gap-3">
                                 @for (freq of ['1', '2', '3+']; track freq) {
                                     <label class="cursor-pointer">
                                         <input type="radio" formControlName="brushingFrequency" [value]="freq" class="peer sr-only">
                                         <div class="flex items-center justify-center rounded-lg border border-gray-200 py-2.5 peer-checked:bg-blue-50 peer-checked:border-blue-200 peer-checked:text-blue-700 hover:bg-gray-50 transition-all">
                                             {{ freq }}
                                         </div>
                                     </label>
                                 }
                             </div>
                         </div>
                    </div>
                }

                <!-- STEP 3: HISTORIAL -->
                @if (currentStep === 3) {
                     <div class="animate-in fade-in slide-in-from-right-4 duration-300 space-y-4 rounded-xl bg-white p-6 shadow-sm border border-gray-100" formGroupName="history">
                        <div>
                            <label class="mb-1.5 block text-sm font-semibold text-gray-700">Alergias</label>
                            <textarea formControlName="allergies" rows="3" class="w-full rounded-lg border border-gray-200 bg-gray-50 p-3 text-gray-900 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-100 transition-all resize-none" placeholder="Medicamentos, alimentos, látex..."></textarea>
                        </div>
                        
                        <div>
                            <label class="mb-1.5 block text-sm font-semibold text-gray-700">Medicamentos actuales</label>
                            <textarea formControlName="medications" rows="3" class="w-full rounded-lg border border-gray-200 bg-gray-50 p-3 text-gray-900 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-100 transition-all resize-none" placeholder="Listado de medicamentos..."></textarea>
                        </div>

                        <div>
                            <label class="mb-1.5 block text-sm font-semibold text-gray-700">Enfermedades / Cirugías</label>
                            <textarea formControlName="illnesses" rows="3" class="w-full rounded-lg border border-gray-200 bg-gray-50 p-3 text-gray-900 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-100 transition-all resize-none" placeholder="Diabetes, hipertensión, cirugías previas..."></textarea>
                        </div>
                     </div>
                }

                <!-- STEP 4: ADJUNTOS -->
                @if (currentStep === 4) {
                     <div class="animate-in fade-in slide-in-from-right-4 duration-300 space-y-4 rounded-xl bg-white p-6 shadow-sm border border-gray-100">
                         <div class="relative flex flex-col items-center justify-center rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 p-8 transition-colors hover:border-blue-400 hover:bg-blue-50">
                             <input type="file" multiple (change)="onFileSelected($event)" class="absolute inset-0 cursor-pointer opacity-0">
                             <div class="flex h-12 w-12 items-center justify-center rounded-full bg-blue-100 text-blue-600 mb-3">
                                 <mat-icon svgIcon="heroicons_outline:cloud-arrow-up"></mat-icon>
                             </div>
                             <p class="font-semibold text-gray-900">Click para subir archivos</p>
                             <p class="text-xs text-gray-500 mt-1">PNG, JPG, PDF hasta 10MB</p>
                         </div>

                         @if (uploadedFiles.length > 0) {
                             <div class="space-y-2">
                                 <p class="text-xs font-semibold uppercase text-gray-500">Archivos seleccionados</p>
                                 @for (file of uploadedFiles; track file.name; let i = $index) {
                                     <div class="flex items-center justify-between rounded-lg border border-gray-100 bg-white p-3 shadow-sm">
                                         <div class="flex items-center gap-3">
                                             <mat-icon class="text-blue-500" svgIcon="heroicons_outline:document"></mat-icon>
                                             <div class="flex flex-col">
                                                  <span class="text-sm font-medium text-gray-900 truncate max-w-[150px]">{{ file.name }}</span>
                                                  <span class="text-xs text-gray-500">{{ (file.size / 1024).toFixed(1) }} KB</span>
                                             </div>
                                         </div>
                                         <button mat-icon-button color="warn" (click)="removeFile(i)">
                                             <mat-icon class="icon-size-4" svgIcon="heroicons_outline:trash"></mat-icon>
                                         </button>
                                     </div>
                                 }
                             </div>
                         }
                     </div>
                }

            </form>
        </div>

        <div class="border-t border-gray-200 bg-gray-50 px-6 py-4">
            <div class="flex items-center justify-between gap-3">
                <button
                    type="button"
                    (click)="cerrarSidebar()"
                    class="rounded-xl border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 shadow-sm transition-all hover:bg-gray-100"
                >
                    Cancelar
                </button>
                <div class="flex gap-2">
                    <button
                        type="button"
                        (click)="prevStep()"
                        class="rounded-xl border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 shadow-sm transition-all hover:bg-gray-100"
                        [disabled]="currentStep === 1"
                    >
                        Atrás
                    </button>
                    <button
                        type="button"
                        (click)="grabarPaciente()"
                        class="flex items-center justify-center gap-2 rounded-xl bg-blue-600 px-4 py-2.5 text-sm font-medium text-white shadow-md transition-all hover:bg-blue-700 disabled:opacity-60"
                        [disabled]="isSaving"
                    >
                        <mat-icon svgIcon="feather:save" class="h-4 w-4"></mat-icon>
                        @if (currentStep < steps.length) { Siguiente } @else { Guardar }
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
