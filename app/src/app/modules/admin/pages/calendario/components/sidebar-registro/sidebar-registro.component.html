<div class="fixed inset-0 z-50 flex justify-end bg-black/50 backdrop-blur-sm" @slideInOut (click)="close()">
    <div
        class="sidebar-panel animate-in slide-in-from-right flex h-full w-full max-w-4xl flex-col overflow-hidden bg-white shadow-2xl transition-all duration-300 ease-in-out"
        (click)="$event.stopPropagation()"
    >
        <div class="flex h-full">
            <div class="flex w-20 flex-col items-center border-r border-gray-100 bg-gray-50 py-6">
                <div class="mb-8 flex h-10 w-10 items-center justify-center rounded-xl bg-blue-100 text-blue-600">
                    <mat-icon class="icon-size-6" svgIcon="heroicons_outline:calendar"></mat-icon>
                </div>
                <div class="flex flex-col gap-4">
                    <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-white text-blue-600 shadow-sm ring-2 ring-blue-100">
                        <mat-icon class="icon-size-5" svgIcon="heroicons_outline:plus"></mat-icon>
                    </div>
                    <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-white text-gray-400 shadow-sm">
                        <mat-icon class="icon-size-5" svgIcon="heroicons_outline:user"></mat-icon>
                    </div>
                    <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-white text-gray-400 shadow-sm">
                        <mat-icon class="icon-size-5" svgIcon="heroicons_outline:clock"></mat-icon>
                    </div>
                </div>
            </div>

            <div class="flex flex-1 flex-col overflow-hidden" [formGroup]="formulario">
                <div class="flex items-center justify-between border-b border-gray-100 px-8 py-4">
                    <div>
                        <div class="text-sm font-medium text-gray-500">Nueva cita</div>
                        <div class="flex items-center gap-2 text-lg font-bold text-gray-900">
                            {{ selectedDate() | date: 'EEEE d MMMM':undefined:'es-ES' }}
                            <span class="text-sm font-medium text-gray-500">·</span>
                            <span class="text-sm font-semibold text-blue-600">{{ dentist()?.name }}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button mat-icon-button (click)="close()" class="text-gray-400 hover:text-gray-600">
                            <mat-icon svgIcon="heroicons_outline:x-mark"></mat-icon>
                        </button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto bg-gray-50/40 p-8">
                    <div class="mb-6 grid grid-cols-1 gap-6 lg:grid-cols-2">
                        <div class="rounded-2xl border border-gray-100 bg-white p-5 shadow-sm">
                            <div class="mb-4 flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <mat-icon class="icon-size-5 text-blue-500" svgIcon="heroicons_outline:user-circle"></mat-icon>
                                    <h3 class="text-base font-semibold text-gray-900">Paciente</h3>
                                </div>
                                <button
                                    class="text-xs font-medium text-blue-600 hover:underline"
                                    type="button"
                                    (click)="clearPaciente()"
                                    *ngIf="pacienteSeleccionado"
                                >
                                    Limpiar
                                </button>
                            </div>

                            <div class="relative">
                                <div class="flex items-center rounded-xl border border-gray-200 bg-gray-50 px-3 py-2 shadow-sm">
                                    <mat-icon class="icon-size-5 text-gray-400" svgIcon="heroicons_outline:magnifying-glass"></mat-icon>
                                    <input
                                        type="text"
                                        class="ml-2 flex-1 bg-transparent text-sm text-gray-900 outline-none"
                                        placeholder="Buscar paciente"
                                        [formControl]="searchControl"
                                    />
                                </div>
                                <div
                                    class="absolute z-10 mt-2 w-full overflow-hidden rounded-xl border border-gray-100 bg-white shadow-xl"
                                    *ngIf="showResults && searchResults.length > 0"
                                >
                                    @for (patient of searchResults; track patient.id) {
                                        <button
                                            type="button"
                                            class="flex w-full items-center justify-between px-3 py-2 text-left text-sm text-gray-800 hover:bg-gray-50"
                                            (click)="selectPaciente(patient)"
                                        >
                                            <span class="font-medium">{{ patient.name }}</span>
                                            <span class="text-xs text-gray-500">{{ patient.phone || 'Sin teléfono' }}</span>
                                        </button>
                                    }
                                </div>
                            </div>

                            @if (pacienteSeleccionado) {
                                <div class="mt-4 rounded-xl border border-blue-100 bg-blue-50 px-4 py-3 text-sm text-blue-800">
                                    <div class="font-semibold">{{ pacienteSeleccionado.name }}</div>
                                    <div class="text-xs text-blue-700">{{ pacienteSeleccionado.email || 'Sin correo' }}</div>
                                </div>
                            }
                        </div>

                        <div class="rounded-2xl border border-gray-100 bg-white p-5 shadow-sm">
                            <div class="mb-4 flex items-center gap-2">
                                <mat-icon class="icon-size-5 text-blue-500" svgIcon="heroicons_outline:sparkles"></mat-icon>
                                <h3 class="text-base font-semibold text-gray-900">Tratamiento</h3>
                            </div>
                            <mat-form-field appearance="outline" class="w-full mb-4">
                                <mat-label>Selecciona tratamiento</mat-label>
                                <mat-select formControlName="tratamiento">
                                    @for (tratamiento of tratamientos; track tratamiento.id) {
                                        <mat-option [value]="tratamiento.name">{{ tratamiento.name }}</mat-option>
                                    }
                                </mat-select>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="w-full">
                                <mat-label>Estado</mat-label>
                                <mat-select formControlName="estado">
                                    @for (status of edoCitas; track $index) {
                                        <mat-option [value]="status">{{ status }}</mat-option>
                                    }
                                </mat-select>
                            </mat-form-field>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
                        <div class="rounded-2xl border border-gray-100 bg-white p-5 shadow-sm">
                            <div class="mb-4 flex items-center gap-2">
                                <mat-icon class="icon-size-5 text-blue-500" svgIcon="heroicons_outline:clock"></mat-icon>
                                <h3 class="text-base font-semibold text-gray-900">Horario</h3>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>Hora inicio</mat-label>
                                    <mat-select formControlName="startTime">
                                        @for (time of timeInitSlots; track $index) {
                                            <mat-option [value]="time">{{ time }}</mat-option>
                                        }
                                    </mat-select>
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>Hora fin</mat-label>
                                    <mat-select formControlName="endTime">
                                        @for (time of filteredEndSlots; track $index) {
                                            <mat-option [value]="time">{{ time }}</mat-option>
                                        }
                                    </mat-select>
                                </mat-form-field>
                            </div>
                            <p class="mt-2 text-xs text-gray-500">Los horarios se calculan según la disponibilidad del odontólogo.</p>
                            @if (currentErrors) {
                                <div class="mt-3 rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-xs font-medium text-red-700">
                                    {{ currentErrors }}
                                </div>
                            }
                        </div>

                        <div class="rounded-2xl border border-gray-100 bg-white p-5 shadow-sm">
                            <div class="mb-4 flex items-center gap-2">
                                <mat-icon class="icon-size-5 text-blue-500" svgIcon="heroicons_outline:calendar-days"></mat-icon>
                                <h3 class="text-base font-semibold text-gray-900">Resumen</h3>
                            </div>
                            <div class="space-y-2 text-sm text-gray-700">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-500">Fecha</span>
                                    <span class="font-semibold text-gray-900">{{ selectedDate() | date: 'fullDate':undefined:'es-ES' }}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-500">Odontólogo</span>
                                    <span class="font-semibold text-gray-900">{{ dentist()?.name }}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-500">Estado</span>
                                    <span class="font-semibold text-gray-900">{{ formulario.value.estado }}</span>
                                </div>
                            </div>
                            @if (currentErrors) {
                                <div class="mt-4 rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-xs text-red-700">
                                    {{ currentErrors }}
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between border-t border-gray-100 px-8 py-4">
                    <button
                        type="button"
                        class="rounded-xl border border-gray-200 bg-white px-5 py-2.5 text-sm font-medium text-gray-700 shadow-sm transition-colors hover:bg-gray-50"
                        (click)="close()"
                    >
                        Cancelar
                    </button>
                    <button
                        type="button"
                        class="rounded-xl bg-blue-600 px-5 py-2.5 text-sm font-semibold text-white shadow-md transition-colors hover:bg-blue-700"
                        (click)="createAppointment()"
                    >
                        Crear cita
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
