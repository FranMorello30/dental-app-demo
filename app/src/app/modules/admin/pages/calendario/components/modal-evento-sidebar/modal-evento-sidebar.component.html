<div
    class="fixed inset-0 z-50 flex items-start justify-end bg-black/40 px-6 py-8 backdrop-blur-md"
    (click)="close()"
>
    <!-- animate-in slide-in-from-right -->
    <div
        class="animate-in slide-in-from-right relative flex h-[90vh] max-h-[900px] w-full flex-col overflow-hidden rounded-2xl border border-gray-100 bg-white shadow-2xl transition-all duration-300 ease-in-out"
        [ngClass]="isExpanded ? 'max-w-5xl' : 'max-w-2xl'"
        (click)="$event.stopPropagation()"
    >
        <div class="flex h-full">
            <!-- Expanded Content (Left Side) -->
            <div
                class="flex flex-col overflow-hidden border-r border-gray-100 bg-white transition-all duration-300 ease-in-out"
                [ngClass]="isExpanded ? 'w-80 opacity-100' : 'w-0 opacity-0'"
            >
                <div
                    class="flex items-center justify-between border-b border-gray-100 p-4"
                >
                    <h3 class="font-bold text-gray-900">
                        @if (activeView === 'habits') {
                            Oral Hygiene Habits
                        } @else if (activeView === 'odontogram') {
                            Odontograma
                        } @else {
                            Subida de archivos
                        }
                    </h3>
                    <button mat-icon-button (click)="toggleExpand()">
                        <mat-icon
                            svgIcon="heroicons_outline:chevron-left"
                            class="text-gray-400"
                        ></mat-icon>
                    </button>
                </div>
                <div class="flex-1 space-y-4 overflow-y-auto p-4">
                    <div [style.display]="activeView === 'habits' ? 'block' : 'none'">
                        <!-- Mock Content -->
                        <div class="rounded-xl bg-gray-50 p-4">
                            <div class="flex items-start gap-3">
                                <div
                                    class="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-blue-600 text-xs font-bold text-white"
                                >
                                    1
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">
                                        When did you make the latest dental
                                        visit?
                                    </div>
                                    <div class="font-medium text-gray-900">
                                        Less than 3 months ago
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="rounded-xl bg-gray-50 p-4">
                            <div class="flex items-start gap-3">
                                <div
                                    class="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-blue-600 text-xs font-bold text-white"
                                >
                                    2
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">
                                        What time did you start dental care?
                                    </div>
                                    <div class="font-medium text-gray-900">
                                        Teenager
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="rounded-xl bg-gray-50 p-4">
                            <div class="flex items-start gap-3">
                                <div
                                    class="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-blue-600 text-xs font-bold text-white"
                                >
                                    3
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">
                                        How many time, in a day, do you wash
                                        your teeth?
                                    </div>
                                    <div class="font-medium text-gray-900">
                                        Once
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="rounded-xl bg-gray-50 p-4">
                            <div class="flex items-start gap-3">
                                <div
                                    class="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-blue-600 text-xs font-bold text-white"
                                >
                                    4
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">
                                        Do you use mouthwash?
                                    </div>
                                    <div class="font-medium text-gray-900">
                                        From 3 to 6 months ago
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div [style.display]="activeView === 'odontogram' ? 'block' : 'none'">
                        <app-odontograma-sidebar [(selectedTeeth)]="teethSelection"></app-odontograma-sidebar>
                    </div>
                    <div [style.display]="activeView === 'uploads' ? 'block' : 'none'">
                        <upload-archivo (filesUploaded)="uploadFiles($event)"></upload-archivo>
                    </div>
                    <div [style.display]="activeView === 'finish' ? 'block' : 'none'">
                        <div class="space-y-4 rounded-xl bg-gray-50 p-4">
                             <div class="mb-2 rounded-lg bg-blue-50 p-3 text-sm text-blue-700">
                                 <p class="font-bold">Finalizando Cita</p>
                                 <p>Por favor complete el registro médico para cerrar la cita.</p>
                             </div>

                             @if (isDev) {
                                 <div class="flex justify-end">
                                     <button
                                         type="button"
                                         class="rounded-lg border border-blue-200 bg-blue-50 px-3 py-1.5 text-xs font-semibold text-blue-700 transition-colors hover:bg-blue-100"
                                         (click)="fillDemoFinish()"
                                     >
                                         Generar datos demo
                                     </button>
                                 </div>
                             }

                             <div>
                                <label class="mb-1 block text-sm font-medium text-gray-700">Diagnóstico <span class="text-red-500">*</span></label>
                                <textarea [(ngModel)]="finishForm.diagnosis" rows="3" class="w-full rounded-lg border border-gray-200 p-2 text-sm focus:border-blue-500 focus:outline-none" placeholder="Diagnóstico principal..."></textarea>
                             </div>

                             <div>
                                <label class="mb-1 block text-sm font-medium text-gray-700">Tratamiento Realizado <span class="text-red-500">*</span></label>
                                <textarea [(ngModel)]="finishForm.treatment" rows="3" class="w-full rounded-lg border border-gray-200 p-2 text-sm focus:border-blue-500 focus:outline-none" placeholder="Procedimientos realizados..."></textarea>
                             </div>
                             
                             <div>
                                <label class="mb-1 block text-sm font-medium text-gray-700">Receta / Medicamentos</label>
                                <textarea [(ngModel)]="finishForm.medications" rows="2" class="w-full rounded-lg border border-gray-200 p-2 text-sm focus:border-blue-500 focus:outline-none" placeholder="Medicamentos recetados..."></textarea>
                             </div>

                             <div>
                                <label class="mb-1 block text-sm font-medium text-gray-700">Notas Adicionales</label>
                                <textarea [(ngModel)]="finishForm.notes" rows="2" class="w-full rounded-lg border border-gray-200 p-2 text-sm focus:border-blue-500 focus:outline-none" placeholder="Notas internas..."></textarea>
                             </div>

                             <button 
                                mat-raised-button 
                                color="primary" 
                                class="w-full !rounded-xl !py-6"
                                (click)="saveMedicalRecord()" 
                                [disabled]="isSavingHistory"
                             >
                                {{ isSavingHistory ? 'Guardando...' : 'Guardar y Finalizar' }}
                             </button>
                        </div>
                    </div>
                </div>
            </div>

            <div
                class="flex w-20 flex-col items-center border-r border-gray-100 bg-gray-50 py-6"
            >
                <div
                    class="mb-8 flex h-10 w-10 items-center justify-center rounded-xl bg-blue-100 text-blue-600"
                >
                    <mat-icon
                        class="icon-size-6"
                        svgIcon="heroicons_outline:calendar"
                    ></mat-icon>
                </div>

                <div class="flex flex-col gap-4">
                    <button
                        (click)="setView('habits')"
                        class="flex h-10 w-10 items-center justify-center rounded-xl bg-white text-gray-400 shadow-sm transition-colors hover:text-blue-600"
                        [ngClass]="{
                            'text-blue-600 ring-2 ring-blue-100':
                                isExpanded && activeView === 'habits',
                        }"
                    >
                        <mat-icon
                            class="icon-size-5"
                            svgIcon="heroicons_outline:clipboard-document-list"
                        ></mat-icon>
                    </button>
                    <button
                        (click)="setView('finish')"
                        class="flex h-10 w-10 items-center justify-center rounded-xl bg-white text-gray-400 shadow-sm transition-colors hover:text-blue-600"
                        [ngClass]="{
                            'text-blue-600 ring-2 ring-blue-100':
                                isExpanded && activeView === 'finish',
                        }"
                    >
                        <mat-icon
                            class="icon-size-5"
                            svgIcon="heroicons_outline:check-circle"
                        ></mat-icon>
                    </button>
                    <button
                        (click)="setView('odontogram')"
                        class="flex h-10 w-10 items-center justify-center rounded-xl bg-white text-gray-400 shadow-sm transition-colors hover:text-blue-600"
                        [ngClass]="{
                            'text-blue-600 ring-2 ring-blue-100':
                                isExpanded && activeView === 'odontogram',
                        }"
                    >
                        <mat-icon
                            class="icon-size-5"
                            svgIcon="heroicons_outline:user"
                        ></mat-icon>
                    </button>
                    <button
                        (click)="setView('uploads')"
                        class="flex h-10 w-10 items-center justify-center rounded-xl bg-white text-gray-400 shadow-sm transition-colors hover:text-blue-600"
                        [ngClass]="{
                            'text-blue-600 ring-2 ring-blue-100':
                                isExpanded && activeView === 'uploads',
                        }"
                    >
                        <mat-icon
                            class="icon-size-5"
                            svgIcon="heroicons_outline:document-text"
                        ></mat-icon>
                    </button>
                    
                </div>
            </div>

            <!-- Main Content -->
            <div class="flex flex-1 flex-col overflow-hidden">
                <!-- Header -->
                <div
                    class="flex items-center justify-between border-b border-gray-100 px-8 py-4"
                >
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-gray-500"
                            >Reservation ID</span
                        >
                        <span class="font-bold text-gray-900"
                            >#RSVA{{ selectedEvent().id.substring(0, 4) }}</span
                        >
                        <span
                            class="ml-2 rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-600"
                            >MANUAL APPOINTMENT</span
                        >
                    </div>
                    <div class="flex items-center gap-2">
                        <button
                            mat-icon-button
                            class="text-gray-400 hover:text-blue-600 disabled:opacity-30"
                            (click)="startEdit()"
                            [disabled]="isFinalized"
                        >
                            <mat-icon
                                svgIcon="heroicons_outline:pencil"
                            ></mat-icon>
                        </button>
                        <button
                            mat-icon-button
                            (click)="close()"
                            class="text-gray-400 hover:text-gray-600"
                        >
                            <mat-icon
                                svgIcon="heroicons_outline:x-mark"
                            ></mat-icon>
                        </button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-8">
                    <!-- Patient Card -->
                    <div
                        class="mb-8 flex items-center justify-between rounded-2xl border border-gray-100 p-4 shadow-sm"
                    >
                        <div class="flex items-center gap-4">
                            <div
                                class="flex h-12 w-12 items-center justify-center rounded-full bg-purple-100 text-lg font-bold text-purple-600"
                            >
                                {{ selectedEvent().patient.name.charAt(0) }}
                            </div>
                            <div>
                                <div
                                    class="text-xs font-medium uppercase text-gray-500"
                                >
                                    Patient name
                                </div>
                                <div class="text-lg font-bold text-gray-900">
                                    {{ selectedEvent().patient.name }}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-500"
                                >Change Status</span
                            >
                            <div
                                class="relative flex w-56 items-center rounded-lg border border-gray-200 bg-white px-2 py-1.5 text-sm font-medium text-gray-700 shadow-sm"
                            >
                                <mat-select
                                    class="flex-1 text-sm font-medium text-gray-800"
                                    [value]="selectedEvent().status"
                                    (valueChange)="changeStatus($event)"
                                    [disabled]="updatingStatus || isFinalized"
                                    disableOptionCentering
                                    panelClass="status-select-panel"
                                >
                                    <mat-select-trigger>
                                        <div class="flex items-center gap-2">
                                            <span
                                                class="h-2 w-2 rounded-full"
                                                [ngClass]="
                                                    getStatusColorClass(
                                                        selectedEvent().status
                                                    )
                                                "
                                            ></span>
                                            <span class="text-sm font-semibold text-gray-900">
                                                {{ selectedEvent().status }}
                                            </span>
                                        </div>
                                    </mat-select-trigger>

                                    @for (status of getAvailableStatuses(); track $index) {
                                        <mat-option [value]="status">
                                            <div class="flex items-center gap-2">
                                                <span
                                                    class="h-2 w-2 rounded-full"
                                                    [ngClass]="
                                                        getStatusColorClass(
                                                            status
                                                        )
                                                    "
                                                ></span>
                                                <span class="text-sm font-medium text-gray-900">
                                                    {{ status }}
                                                </span>
                                            </div>
                                        </mat-option>
                                    }
                                </mat-select>

                                <mat-icon
                                    *ngIf="updatingStatus"
                                    class="absolute right-2 animate-spin text-gray-300 icon-size-4"
                                    svgIcon="heroicons_mini:arrow-path"
                                ></mat-icon>
                            </div>
                        </div>
                    </div>

                    <!-- Info Grid -->
                    <div class="mb-8 grid grid-cols-3 gap-4">
                        <div class="flex items-start gap-3">
                            <div
                                class="flex h-10 w-10 items-center justify-center rounded-lg bg-gray-50 text-gray-400"
                            >
                                <mat-icon
                                    class="icon-size-5"
                                    svgIcon="heroicons_outline:sparkles"
                                ></mat-icon>
                            </div>
                            <div>
                                <div
                                    class="text-xs font-medium uppercase text-gray-500"
                                >
                                    TREATMENT
                                </div>
                                <div class="font-semibold text-gray-900">
                                    {{ selectedEvent().treatment }}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <div
                                class="flex h-10 w-10 items-center justify-center rounded-lg bg-gray-50 text-gray-400"
                            >
                                <mat-icon
                                    class="icon-size-5"
                                    svgIcon="heroicons_outline:clock"
                                ></mat-icon>
                            </div>
                            <div>
                                <div
                                    class="text-xs font-medium uppercase text-gray-500"
                                >
                                    DATE AND TIME
                                </div>
                                <div class="font-semibold text-gray-900">
                                    {{
                                        selectedEvent().start_time
                                            | date: 'EEE, d MMM'
                                    }}
                                </div>
                                <div class="text-sm text-gray-500">
                                    {{
                                        selectedEvent().start_time
                                            | date: 'hh:mm a'
                                    }}
                                    -
                                    {{
                                        selectedEvent().end_time
                                            | date: 'hh:mm a'
                                    }}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <div
                                class="flex h-10 w-10 items-center justify-center rounded-lg bg-gray-50 text-gray-400"
                            >
                                <mat-icon
                                    class="icon-size-5"
                                    svgIcon="heroicons_outline:user"
                                ></mat-icon>
                            </div>
                            <div>
                                <div
                                    class="text-xs font-medium uppercase text-gray-500"
                                >
                                    DENTIST
                                </div>
                                <div class="font-semibold text-gray-900">
                                    {{ selectedEvent().dentist.name }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-8 h-px w-full bg-gray-100"></div>

                    <!-- Payment Section -->
                    <div class="mb-8 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500">Payment</span>
                            <span class="font-bold text-gray-900"
                                >Bill #10102</span
                            >
                            <span
                                class="rounded bg-red-100 px-2 py-0.5 text-xs font-bold text-red-600"
                                >UNPAID</span
                            >
                        </div>
                        <button
                            class="flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
                        >
                            <mat-icon
                                class="text-yellow-500 icon-size-4"
                                svgIcon="heroicons_outline:bell"
                            ></mat-icon>
                            Send Reminder
                        </button>
                    </div>

                    <div class="mb-8 h-px w-full bg-gray-100"></div>

                    <!-- Reschedule -->
                    @if (rescheduleMode) {
                        <div class="mb-8 rounded-2xl border border-gray-100 p-4 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-semibold uppercase text-gray-500">
                                        Reprogramar cita
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        Ajusta fecha y hora de la cita.
                                    </div>
                                </div>
                                <button
                                    class="rounded-lg border border-gray-200 px-3 py-1.5 text-sm font-medium text-blue-600 hover:bg-blue-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                    (click)="cancelReschedule()"
                                    [disabled]="rescheduling || isFinalized"
                                >
                                    Cancelar
                                </button>
                            </div>

                            <div class="mt-4 grid grid-cols-2 gap-4">
                                <div class="rounded-xl border border-gray-100 bg-gray-50/60 p-3">
                                    <div class="mb-2 flex items-center justify-between">
                                        <button
                                            type="button"
                                            class="flex h-8 w-8 items-center justify-center rounded-full border border-gray-200 bg-white text-gray-600 hover:bg-gray-100"
                                            (click)="goToPrevious()"
                                            [disabled]="rescheduling"
                                        >
                                            <mat-icon svgIcon="feather:chevron-left" class="icon-size-4" />
                                        </button>
                                        <div class="text-sm font-semibold text-gray-900">
                                            {{ getFormattedMonth() }}
                                        </div>
                                        <button
                                            type="button"
                                            class="flex h-8 w-8 items-center justify-center rounded-full border border-gray-200 bg-white text-gray-600 hover:bg-gray-100"
                                            (click)="goToNext()"
                                            [disabled]="rescheduling"
                                        >
                                            <mat-icon svgIcon="feather:chevron-right" class="icon-size-4" />
                                        </button>
                                    </div>
                                    <div class="mb-1 grid grid-cols-7 gap-1 text-center text-[11px] font-semibold uppercase text-gray-400">
                                        @for (day of weekDays; track $index) {
                                            <div>{{ day }}</div>
                                        }
                                    </div>
                                    <div class="grid grid-cols-7 gap-1">
                                        @for (day of getMiniCalendarData(); track $index) {
                                            @if (!day) {
                                                <div class="h-10 rounded-lg"></div>
                                            } @else {
                                                <button
                                                    type="button"
                                                    class="flex h-10 w-full items-center justify-center rounded-lg text-sm font-semibold transition-all"
                                                    [ngClass]="{
                                                        'bg-blue-600 text-white shadow-md': isSelectedDay(day),
                                                        'text-gray-900 hover:bg-blue-50': !isPastOrUnavailable(day) && !isSelectedDay(day),
                                                        'bg-gray-100 text-gray-400 cursor-not-allowed opacity-60': isPastOrUnavailable(day)
                                                    }"
                                                    (click)="selectDate(day)"
                                                    [disabled]="isPastOrUnavailable(day) || rescheduling"
                                                >
                                                    {{ day }}
                                                </button>
                                            }
                                        }
                                    </div>
                                </div>

                                <div class="space-y-3">
                                    <div class="flex flex-col gap-1.5">
                                        <label class="text-xs font-semibold uppercase text-gray-500">Hora de inicio</label>
                                        <div class="relative">
                                            <select
                                                class="w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-800 focus:border-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-100"
                                                [(ngModel)]="rescheduleData.startTime"
                                                name="rescheduleStart"
                                                [disabled]="rescheduling"
                                            >
                                                <option value="" disabled>Selecciona hora</option>
                                                @for (time of timeSlots; track $index) {
                                                    <option [value]="time">{{ time }}</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-1.5">
                                        <label class="text-xs font-semibold uppercase text-gray-500">Hora de fin</label>
                                        <div class="relative">
                                            <select
                                                class="w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-800 focus:border-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-100"
                                                [(ngModel)]="rescheduleData.endTime"
                                                name="rescheduleEnd"
                                                [disabled]="rescheduling"
                                            >
                                                <option value="" disabled>Selecciona hora</option>
                                                @for (time of timeSlots; track $index) {
                                                    <option [value]="time">{{ time }}</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p class="mt-2 text-xs text-gray-500">
                                Selecciona la fecha y horarios para reprogramar la cita.
                            </p>
                        </div>
                    }

                    <!-- General Info -->
                    @if (!rescheduleMode) {
                        <div>
                            <h3 class="mb-4 font-bold text-gray-900">
                                General info
                            </h3>
                            <div class="grid grid-cols-2 gap-x-8 gap-y-6">
                                <div>
                                    <div
                                        class="mb-1 text-xs font-medium uppercase text-gray-500"
                                    >
                                        FULL NAME
                                    </div>
                                    <div class="text-gray-900">
                                        {{ selectedEvent().patient.name }}
                                    </div>
                                </div>
                                <div>
                                    <div
                                        class="mb-1 text-xs font-medium uppercase text-gray-500"
                                    >
                                        PHONE NUMBER
                                    </div>
                                    <div class="flex items-center gap-2 text-gray-900">
                                        <span>
                                            {{
                                                selectedEvent().patient.phone ||
                                                    '+1 (555) 000-0000'
                                            }}
                                        </span>
                                        <button
                                            *ngIf="selectedEvent().patient.phone"
                                            mat-icon-button
                                            class="h-6 w-6 text-green-600 hover:bg-green-50"
                                            (click)="sendMessageToPatient()"
                                            title="Enviar mensaje por WhatsApp"
                                        >
                                            <mat-icon
                                                class="icon-size-4"
                                                svgIcon="heroicons_outline:chat-bubble-left-right"
                                            ></mat-icon>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <div
                                        class="mb-1 text-xs font-medium uppercase text-gray-500"
                                    >
                                        AGE
                                    </div>
                                    <div class="text-gray-900">24</div>
                                </div>
                                <div>
                                    <div
                                        class="mb-1 text-xs font-medium uppercase text-gray-500"
                                    >
                                        EMAIL
                                    </div>
                                    <div class="text-gray-900">
                                        {{
                                            selectedEvent().patient.email ||
                                                'No email'
                                        }}
                                    </div>
                                </div>
                                <div>
                                    <div
                                        class="mb-1 text-xs font-medium uppercase text-gray-500"
                                    >
                                        GENDER
                                    </div>
                                    <div class="text-gray-900">Male</div>
                                </div>
                                <div>
                                    <div
                                        class="mb-1 text-xs font-medium uppercase text-gray-500"
                                    >
                                        ADDRESS
                                    </div>
                                    <div class="text-gray-900">
                                        {{
                                            selectedEvent().patient.address ||
                                                'No address'
                                        }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Footer -->
                <div
                    class="flex items-center justify-between border-t border-gray-100 px-8 py-4"
                >
                    <button
                        (click)="cancelAppointment()"
                        [disabled]="isFinalized"
                        class="rounded-xl border border-red-200 bg-white px-6 py-2.5 text-sm font-medium text-red-600 hover:bg-red-50 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Cancel
                    </button>
                    <button
                        #btnAction
                        class="rounded-xl border border-gray-200 bg-white px-6 py-2.5 text-sm font-medium text-blue-600 hover:bg-blue-50 disabled:opacity-50 disabled:cursor-not-allowed"
                        [disabled]="rescheduling || isFinalized"
                        (click)="rescheduleMode ? confirmReschedule() : startReschedule()"
                    >
                        {{ rescheduleMode ? 'Guardar cambios' : 'Reprogramar' }}
                        <mat-icon
                            *ngIf="rescheduling"
                            class="ml-2 animate-spin text-gray-300 icon-size-4"
                            svgIcon="heroicons_mini:arrow-path"
                        ></mat-icon>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
