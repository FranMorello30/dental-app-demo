<div class="relative min-h-screen w-full overflow-hidden bg-slate-50">
    <div class="relative flex h-full w-full items-start pb-4 pt-1">
       
        <div
            class="z-10 flex h-full w-72 flex-col items-start justify-between border-r border-gray-200 bg-white p-6 shadow-lg"
        >
            <div class="mb-6 w-full">
                <label
                    class="mb-2 block text-sm font-semibold uppercase tracking-wide text-gray-700"
                    >Odontólogo</label
                >
                <mat-select
                    [formControl]="selectDentist"
                    class="w-full rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-gray-900 transition-all focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    @for (dentist of dentists; track dentist.id) {
                        <mat-option [value]="dentist">
                            {{ dentist.name }}
                        </mat-option>
                    }
                </mat-select>
            </div>

            <button
                [disabled]="!dentist"
                (click)="crearCita()"
                class="mb-8 flex w-full items-center justify-center gap-2 rounded-xl bg-blue-600 py-3 text-white shadow-md transition-all hover:bg-blue-700 active:scale-95"
                [ngClass]="{ 'cursor-not-allowed opacity-50': !dentist }"
            >
                <mat-icon
                    class="text-white icon-size-5"
                    svgIcon="feather:plus"
                ></mat-icon>
                <span class="font-medium">Nueva Cita</span>
            </button>

            <div class="mb-8">
                <div class="mb-4 flex items-center justify-between">
                    <h3 class="text-lg font-bold capitalize text-gray-900">
                        {{ getFormattedDate() }}
                    </h3>
                    <div class="flex items-center gap-1">
                        <button
                            mat-icon-button
                            class="flex h-8 w-8 items-center justify-center rounded-full text-gray-600 transition-colors hover:bg-gray-100"
                            (click)="changeMonth(-1)"
                        >
                            <mat-icon
                                class="icon-size-5"
                                svgIcon="feather:chevron-left"
                            ></mat-icon>
                        </button>
                        <button
                            mat-icon-button
                            class="flex h-8 w-8 items-center justify-center rounded-full text-gray-600 transition-colors hover:bg-gray-100"
                            (click)="changeMonth(1)"
                        >
                            <mat-icon
                                class="icon-size-5"
                                svgIcon="feather:chevron-right"
                            ></mat-icon>
                        </button>
                    </div>
                </div>
                <div class="mb-2 grid grid-cols-7 gap-1 text-center">
                    @for (item of diasMini; track $index) {
                        <div class="py-1 text-xs font-semibold text-gray-400">
                            {{ item === 'X' ? 'Mi' : item }}
                        </div>
                    }
                    @for (day of getMiniCalendarData(); track $index) {
                        <div
                            class="flex h-8 w-8 items-center justify-center rounded-full text-xs font-medium transition-all duration-200"
                            [class]="
                                day === currentDate.getDate()
                                    ? 'bg-blue-600 text-white shadow-md'
                                    : 'text-gray-700 hover:bg-gray-100'
                            "
                            [ngClass]="
                                getPastDay(day)
                                    ? 'cursor-not-allowed opacity-30'
                                    : 'cursor-pointer'
                            "
                            (click)="handleMiniDayClick(day)"
                        >
                            {{ day }}
                        </div>
                    }
                </div>
            </div>

            <div class="w-full flex-1">
                <h3
                    class="mb-4 text-sm font-bold uppercase tracking-wide text-gray-900"
                >
                    Resumen de Citas
                </h3>
                <div class="w-full space-y-3">
                    <div
                        class="group flex cursor-default items-center justify-between"
                    >
                        <span
                            class="flex items-center gap-3 text-sm text-gray-600"
                        >
                            <div
                                class="h-2.5 w-2.5 rounded-full bg-yellow-400 shadow-sm ring-2 ring-yellow-100"
                            ></div>
                            Sin confirmar
                        </span>
                        <span
                            class="rounded-md bg-gray-100 px-2 py-0.5 text-sm font-semibold text-gray-900"
                            >{{ totByStatus('Sin confirmar') }}</span
                        >
                    </div>
                    <div
                        class="group flex cursor-default items-center justify-between"
                    >
                        <span
                            class="flex items-center gap-3 text-sm text-gray-600"
                        >
                            <div
                                class="h-2.5 w-2.5 rounded-full bg-green-500 shadow-sm ring-2 ring-green-100"
                            ></div>
                            Confirmada
                        </span>
                        <span
                            class="rounded-md bg-gray-100 px-2 py-0.5 text-sm font-semibold text-gray-900"
                            >{{ totByStatus('Confirmada') }}</span
                        >
                    </div>
                    <div
                        class="group flex cursor-default items-center justify-between"
                    >
                        <span
                            class="flex items-center gap-3 text-sm text-gray-600"
                        >
                            <div
                                class="h-2.5 w-2.5 rounded-full bg-purple-500 shadow-sm ring-2 ring-purple-100"
                            ></div>
                            En consulta
                        </span>
                        <span
                            class="rounded-md bg-gray-100 px-2 py-0.5 text-sm font-semibold text-gray-900"
                            >{{ totByStatus('En consulta') }}</span
                        >
                    </div>
                    <div
                        class="group flex cursor-default items-center justify-between"
                    >
                        <span
                            class="flex items-center gap-3 text-sm text-gray-600"
                        >
                            <div
                                class="h-2.5 w-2.5 rounded-full bg-red-500 shadow-sm ring-2 ring-red-100"
                            ></div>
                            Cancelada
                        </span>
                        <span
                            class="rounded-md bg-gray-100 px-2 py-0.5 text-sm font-semibold text-gray-900"
                            >{{ totByStatus('Cancelada') }}</span
                        >
                    </div>
                    <div
                        class="group flex cursor-default items-center justify-between"
                    >
                        <span
                            class="flex items-center gap-3 text-sm text-gray-600"
                        >
                            <div
                                class="h-2.5 w-2.5 rounded-full bg-gray-500 shadow-sm ring-2 ring-gray-100"
                            ></div>
                            Finalizada
                        </span>
                        <span
                            class="rounded-md bg-gray-100 px-2 py-0.5 text-sm font-semibold text-gray-900"
                            >{{ totByStatus('Finalizada') }}</span
                        >
                    </div>
                </div>
            </div>

            <div class="mt-8 w-full border-t border-gray-100 pt-6">
                <h3
                    class="mb-3 flex items-center gap-2 text-xs font-bold uppercase tracking-wide text-gray-900"
                >
                    <mat-icon
                        svgIcon="feather:alert-circle"
                        class="text-orange-500 icon-size-4"
                    />
                    Pendientes de documentar
                </h3>
                <div
                    class="custom-scrollbar max-h-40 space-y-2 overflow-y-auto pr-1"
                >
                    @for (event of allEvents; track $index) {
                        @if (event.status === 'Finalizada (Pendiente)') {
                            <div
                                (click)="eventDetails(event)"
                                class="group cursor-pointer rounded-lg border border-orange-100 bg-orange-50 p-3 transition-colors hover:bg-orange-100"
                            >
                                <div
                                    class="text-sm font-semibold text-gray-800 group-hover:text-orange-800"
                                >
                                    {{ event.treatment }}
                                </div>
                                <div class="mt-1 text-xs text-gray-500">
                                    {{ event.patientName }}
                                    {{ event.patientLastName }}
                                </div>
                                <div
                                    class="mt-2 flex items-center text-xs text-gray-400"
                                >
                                    <mat-icon
                                        svgIcon="feather:calendar"
                                        class="mr-1.5 icon-size-3"
                                    />
                                    {{
                                        event.start_time.toLocaleDateString(
                                            'es-ES',
                                            { month: 'short', day: 'numeric' }
                                        )
                                    }}
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <div class="flex h-full flex-1 flex-col overflow-hidden bg-slate-50">
            <div class="flex items-center justify-between px-8 py-6">
                <div class="flex items-center gap-6">
                    <button
                        class="rounded-lg bg-blue-50 px-4 py-2 font-medium text-blue-600 transition-colors hover:bg-blue-100"
                        (click)="getCurrentDate()"
                    >
                        Hoy
                    </button>
                    <div
                        class="flex items-center rounded-lg border border-gray-200 bg-white p-0.5 shadow-sm"
                    >
                        <button
                            mat-button
                            class="rounded-md p-2 text-gray-600 transition-colors hover:bg-gray-50"
                            (click)="goToPrevious()"
                        >
                            <mat-icon
                                class="icon-size-5"
                                svgIcon="feather:chevron-left"
                            ></mat-icon>
                        </button>
                        <div class="h-6 w-px bg-gray-200"></div>
                        <button
                            mat-button
                            class="rounded-md p-2 text-gray-600 transition-colors hover:bg-gray-50"
                            (click)="goToNext()"
                        >
                            <mat-icon
                                class="icon-size-5"
                                svgIcon="feather:chevron-right"
                            ></mat-icon>
                        </button>
                    </div>
                    <h2 class="text-2xl font-bold capitalize text-gray-900">
                        {{
                            currentDate.toLocaleDateString('es-ES', {
                                month: 'long',
                                day: 'numeric',
                                year: 'numeric',
                            })
                        }}
                    </h2>
                </div>

                <div
                    class="flex items-center rounded-lg border border-gray-200 bg-white p-1 shadow-sm"
                >
                    <button
                        (click)="onViewChange('day')"
                        class="rounded-md px-4 py-1.5 text-sm font-medium transition-all"
                        [ngClass]="
                            currentView === 'day'
                                ? 'bg-gray-900 text-white shadow-md'
                                : 'text-gray-600 hover:bg-gray-50'
                        "
                    >
                        Día
                    </button>
                    <button
                        (click)="onViewChange('week')"
                        class="rounded-md px-4 py-1.5 text-sm font-medium transition-all"
                        [ngClass]="
                            currentView === 'week'
                                ? 'bg-gray-900 text-white shadow-md'
                                : 'text-gray-600 hover:bg-gray-50'
                        "
                    >
                        Semana
                    </button>
                    <button
                        (click)="onViewChange('month')"
                        class="rounded-md px-4 py-1.5 text-sm font-medium transition-all"
                        [ngClass]="
                            currentView === 'month'
                                ? 'bg-gray-900 text-white shadow-md'
                                : 'text-gray-600 hover:bg-gray-50'
                        "
                    >
                        Mes
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-hidden px-8 pb-8">
                @if (currentView === 'day') {
                    <div
                        class="flex h-full flex-col overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"
                    >
                        <div
                            class="grid grid-cols-[80px_1fr] border-b border-gray-200 bg-gray-50/50"
                        >
                            <div
                                class="border-r border-gray-100 p-4 text-center text-xs font-medium uppercase tracking-wider text-gray-400"
                            >
                                Hora
                            </div>
                            <div class="p-4 text-center">
                                <div
                                    class="text-sm font-medium uppercase tracking-wide text-gray-500"
                                >
                                    {{ formatWeekDay(currentDate) }}
                                </div>
                                <div
                                    class="mt-1 text-2xl font-bold text-blue-600"
                                >
                                    {{ currentDate.getDate() }}
                                </div>
                            </div>
                        </div>
                        <div
                            class="custom-scrollbar grid flex-1 grid-cols-[80px_1fr] overflow-y-auto"
                        >
                            <div
                                class="border-r border-gray-100 bg-gray-50/30 text-gray-400"
                            >
                                @for (time of timeSlots; track $index) {
                                    <div
                                        class="relative flex h-20 items-center justify-end border-b border-gray-100 pr-3 text-right text-xs font-medium"
                                    >
                                        <span class="-translate-y-1/2">{{
                                            time > 12
                                                ? time - 12 + ' PM'
                                                : time === 12
                                                  ? time + ' PM'
                                                  : time + ' AM'
                                        }}</span>
                                    </div>
                                }
                            </div>
                            <div
                                class="relative bg-white"
                                [class]="
                                    !isPastDate(currentDate) &&
                                    isDayAvailable(currentDate) &&
                                    dentist
                                        ? 'cursor-pointer'
                                        : 'cursor-not-allowed'
                                "
                                (click)="onSlotClick(currentDate, $event)"
                            >
                                @if (compareDate(currentDate)) {
                                    <div
                                        class="absolute z-20 w-full pointer-events-none"
                                        [ngStyle]="{
                                            top: getCurrentTimePosition()
                                        }"
                                    >
                                        <div
                                            class="relative w-full border-t-2 border-red-500"
                                        >
                                            <!-- Punto rojo al inicio -->
                                            <div
                                                class="absolute -left-1.5 -top-1.5 h-3 w-3 rounded-full bg-red-500"
                                            ></div>
                                            <!-- Etiqueta con la hora -->
                                            <div
                                                class="absolute -top-6 left-2 rounded shadow-sm bg-red-500 px-1.5 py-0.5 text-[10px] font-bold text-white z-30"
                                            >
                                                {{
                                                    currentTime
                                                        | date: 'hh:mm a'
                                                }}
                                            </div>
                                        </div>
                                    </div>
                                }
                                @for (time of timeSlots; track $index) {
                                    <div
                                        class="h-20 border-b border-gray-100"
                                        (click)="onSlotHourClick(currentDate, time, $event)"
                                    ></div>
                                }
                                @for (
                                    event of getEventsByWeek(currentDate);
                                    track $index
                                ) {
                                    <!-- transition-all duration-200 ease-in-out hover:z-10 hover:scale-[1.02] hover:shadow-md -->
                                    <div
                                        class="absolute cursor-pointer rounded-lg border-l-4 border-white/20 p-3 text-white shadow-sm "
                                        [class]="getStatusColor(event.status)"
                                        [ngStyle]="
                                            calculateEventStyle(
                                                event.start_time,
                                                event.end_time
                                            )
                                        "
                                        (click)="openEvent(event); $event.stopPropagation()"
                                    >
                                        <button 
                                            class="absolute top-1 right-1 flex h-6 w-6 items-center justify-center rounded-full bg-white/20 transition-colors hover:bg-white/40 z-20"
                                            (click)="toggleMessageInput(event.id, $event)"
                                            title="Enviar mensaje"
                                            *ngIf="event.patient.phone"
                                        >
                                            <mat-icon
                                                class="text-white icon-size-3.5"
                                                svgIcon="heroicons_outline:chat-bubble-left-right"
                                            ></mat-icon>
                                        </button>

                                        @if (activeMessageEventId === event.id) {
                                            <div 
                                                @popoverAnimation
                                                class="absolute left-full top-0 z-50 ml-2 w-64 cursor-default rounded-xl bg-white p-3 shadow-xl ring-1 ring-gray-200"
                                                (click)="$event.stopPropagation()"
                                            >
                                                <div class="mb-2 text-xs font-semibold text-gray-900">Mensaje para {{event.patient.name}}</div>
                                                <textarea 
                                                    [(ngModel)]="customMessage"
                                                    class="mb-2 h-20 w-full resize-none rounded-md border border-gray-200 p-2 text-xs text-gray-700 focus:border-blue-500 focus:outline-none"
                                                    placeholder="Escribe tu mensaje aquí..."
                                                ></textarea>
                                                <div class="flex justify-end gap-2">
                                                    <button 
                                                        class="rounded px-2 py-1 text-xs font-medium text-gray-500 hover:bg-gray-100"
                                                        (click)="closeMessageInput($event)"
                                                    >
                                                        Cancelar
                                                    </button>
                                                    <button 
                                                        class="rounded bg-green-500 px-2 py-1 text-xs font-medium text-white hover:bg-green-600"
                                                        (click)="sendCustomMessage(event)"
                                                    >
                                                        Enviar
                                                    </button>
                                                </div>
                                            </div>
                                        }

                                        <div
                                            class="truncate text-sm font-bold shadow-sm"
                                        >
                                            {{ event.treatment }}
                                        </div>
                                        @if (getEventDurationMinutes(event) > 30) {
                                            <div
                                                class="mt-0.5 truncate text-xs font-medium opacity-90"
                                            >
                                                {{
                                                    event.start_time
                                                        | date: 'hh:mm a'
                                                }}
                                                -
                                                {{
                                                    event.end_time | date: 'hh:mm a'
                                                }}
                                            </div>
                                            <div
                                                class="mt-1.5 inline-block rounded bg-black/10 px-1.5 py-0.5 text-[10px] font-medium"
                                            >
                                                Pcte: {{ event.patient.name }}
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
                @if (currentView === 'week') {
                    <div
                        class="flex h-full flex-col overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"
                    >
                        <div
                            class="grid grid-cols-8 border-b border-gray-200 bg-gray-50/50"
                        >
                            <div
                                class="border-r border-gray-100 p-3 text-center text-xs font-medium uppercase tracking-wider text-gray-400"
                            >
                                Hora
                            </div>
                            @for (date of diasemanas; track $index) {
                                <div
                                    class="border-l border-gray-100 p-3 text-center"
                                >
                                    <div
                                        class="text-xs font-medium uppercase tracking-wide text-gray-500"
                                    >
                                        {{ formatWeekDay(date) }}
                                    </div>
                                    <div
                                        class="mt-1 text-xl font-bold transition-colors"
                                        [class]="
                                            compareDate(date)
                                                ? 'text-blue-600'
                                                : 'text-gray-900'
                                        "
                                    >
                                        {{ date.getDate() }}
                                    </div>
                                </div>
                            }
                        </div>
                        <div
                            class="custom-scrollbar grid flex-1 grid-cols-8 overflow-y-auto"
                        >
                            <div
                                class="border-r border-gray-100 bg-gray-50/30 text-gray-400"
                            >
                                @for (time of timeSlots; track $index) {
                                    <div
                                        class="relative flex h-20 items-center justify-end border-b border-gray-100 pr-3 text-right text-xs font-medium"
                                    >
                                        <span class="-translate-y-1/2">{{
                                            time > 12
                                                ? time - 12 + ' PM'
                                                : time === 12
                                                  ? time + ' PM'
                                                  : time + ' AM'
                                        }}</span>
                                    </div>
                                }
                            </div>
                            @for (date of diasemanas; track $index) {
                                <div
                                    class="relative border-l border-gray-100"
                                    [ngClass]="{
                                        'bg-gray-400/50': !isDayAvailable(date),
                                        'cursor-pointer hover:bg-blue-50/10':
                                            !isPastDate(date),
                                        'cursor-not-allowed':
                                            isPastDate(date),
                                    }"
                                    (click)="onSlotClick(date, $event)"
                                >
                                    @if (compareDate(date)) {
                                        <div
                                            class="absolute z-20 w-full pointer-events-none"
                                            [ngStyle]="{
                                                top: getCurrentTimePosition()
                                            }"
                                        >
                                            <div
                                                class="relative w-full border-t-2 border-red-500"
                                            >
                                                <!-- Punto rojo al inicio -->
                                                <div
                                                    class="absolute -left-1.5 -top-1.5 h-3 w-3 rounded-full bg-red-500"
                                                ></div>
                                                <!-- Etiqueta con la hora -->
                                                <div
                                                    class="absolute -top-6 left-2 rounded shadow-sm bg-red-500 px-1.5 py-0.5 text-[10px] font-bold text-white z-30"
                                                >
                                                    {{
                                                        currentTime
                                                            | date: 'hh:mm a'
                                                    }}
                                                </div>
                                            </div>
                                        </div>
                                    }
                                    @for (time of timeSlots; track $index) {
                                        <div
                                            class="h-20 border-b border-gray-100"
                                            (click)="onSlotHourClick(date, time, $event)"
                                        ></div>
                                    }
                                    @if (isDayAvailable(date)) {
                                        @for (
                                            event of getEventsByWeek(date);
                                            track $index
                                        ) {
                                            <!-- transition-all duration-200 ease-in-out hover:z-10 hover:scale-[1.02] hover:shadow-md -->
                                            <div
                                                [title]="
                                                    'Pcte:' + event.patient.name
                                                "
                                                class="absolute cursor-pointer rounded-md border-l-2 border-white/20 p-2 text-white shadow-sm "
                                                [class]="
                                                    getStatusColor(event.status)
                                                "
                                                [ngStyle]="
                                                    calculateEventStyle(
                                                        event.start_time,
                                                        event.end_time
                                                    )
                                                "
                                                (click)="openEvent(event); $event.stopPropagation()"
                                            >
                                                <button 
                                                    class="absolute top-1 right-1 flex h-5 w-5 items-center justify-center rounded-full bg-white/20 transition-colors hover:bg-white/40 z-20"
                                                    (click)="toggleMessageInput(event.id, $event)"
                                                    title="Enviar mensaje"
                                                    *ngIf="event.patient.phone"
                                                >
                                                    <mat-icon
                                                        class="text-white icon-size-3"
                                                        svgIcon="heroicons_outline:chat-bubble-left-right"
                                                    ></mat-icon>
                                                </button>

                                                @if (activeMessageEventId === event.id) {
                                                    <div 
                                                        @popoverAnimation
                                                        class="absolute top-0 z-50 w-64 cursor-default rounded-xl bg-white p-3 shadow-xl ring-1 ring-gray-200"
                                                        [ngClass]="date.getDay() === 6 ? 'right-full mr-2' : 'left-full ml-2'"
                                                        (click)="$event.stopPropagation()"
                                                    >
                                                        <div class="mb-2 text-xs font-semibold text-gray-900">Mensaje para {{event.patient.name}}</div>
                                                        <textarea 
                                                            [(ngModel)]="customMessage"
                                                            class="mb-2 h-20 w-full resize-none rounded-md border border-gray-200 p-2 text-xs text-gray-700 focus:border-blue-500 focus:outline-none"
                                                            placeholder="Escribe tu mensaje aquí..."
                                                        ></textarea>
                                                        <div class="flex justify-end gap-2">
                                                            <button 
                                                                class="rounded px-2 py-1 text-xs font-medium text-gray-500 hover:bg-gray-100"
                                                                (click)="closeMessageInput($event)"
                                                            >
                                                                Cancelar
                                                            </button>
                                                            <button 
                                                                class="rounded bg-green-500 px-2 py-1 text-xs font-medium text-white hover:bg-green-600"
                                                                (click)="sendCustomMessage(event)"
                                                            >
                                                                Enviar
                                                            </button>
                                                        </div>
                                                    </div>
                                                }

                                                <div
                                                    class="truncate text-xs font-bold"
                                                >
                                                    {{ event.treatment }}
                                                </div>
                                                <div
                                                    class="mt-0.5 truncate text-[10px] font-medium opacity-90"
                                                >
                                                    {{
                                                        event.start_time
                                                            | date: 'hh:mm a'
                                                    }}
                                                    -
                                                    {{
                                                        event.end_time
                                                            | date: 'hh:mm a'
                                                    }}
                                                </div>
                                                @if (hasSpaceForPatient(event)) {
                                                    <div
                                                        class="mt-1 inline-block rounded bg-black/10 px-1.5 py-0.5 text-[10px] font-semibold"
                                                    >
                                                        Pcte: {{ event.patient.name }}
                                                    </div>
                                                }
                                            </div>
                                        }
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
                @if (currentView === 'month') {
                    <div class="flex h-full flex-col overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm">
                        <div
                            class="grid grid-cols-7 border-b border-gray-200 bg-gray-50/50"
                        >
                            @for (day of diasHeaderMes; track $index) {
                                <div
                                    class="p-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-500"
                                >
                                    {{ day }}
                                </div>
                            }
                        </div>

                        <div class="grid flex-1 grid-rows-6">
                            @for (week of weeks; track $index) {
                                <div
                                    class="grid h-full grid-cols-7"
                                    [ngClass]="{
                                        'border-b border-gray-100':
                                            $index !== weeks.length - 1,
                                    }"
                                >
                                    @for (day of week; track $index) {
                                        @if (day === null) {
                                            <div
                                                class="border-r border-gray-100 bg-gray-50/30 p-2"
                                            ></div>
                                        } @else {
                                            <div
                                                class="relative flex flex-col border-r border-gray-100 p-2 transition-colors"
                                                [ngClass]="{
                                                    'bg-gray-400/50':
                                                        !isWeekDayAvailable(
                                                            day
                                                        ),
                                                    'hover:bg-blue-50/30':
                                                        !getPastDay(day),
                                                    'cursor-pointer':
                                                        !getPastDay(day),
                                                    'cursor-not-allowed':
                                                        getPastDay(day),
                                                }"
                                                (click)="
                                                    isWeekDayAvailable(day) &&
                                                    !getPastDay(day) &&
                                                    dentist
                                                        ? crearCita(day)
                                                        : null
                                                "
                                            >
                                                <div
                                                    class="mb-1 flex h-7 w-7 items-center justify-center rounded-full text-sm font-medium transition-colors"
                                                    [ngClass]="{
                                                        'text-gray-700':
                                                            isWeekDayAvailable(
                                                                day
                                                            ) &&
                                                            day !==
                                                                currentDate.getDate(),
                                                        'text-gray-400':
                                                            !isWeekDayAvailable(
                                                                day
                                                            ),
                                                        'bg-blue-600 text-white shadow-sm':
                                                            day ===
                                                            currentDate.getDate(),
                                                    }"
                                                >
                                                    {{ day }}
                                                </div>
                                                <div
                                                    class="flex-1 space-y-1 overflow-hidden"
                                                >
                                                    @for (
                                                        event of getEventsByMonth(
                                                            day
                                                        );
                                                        track $index
                                                    ) {
                                                        @if ($index < 2) {
                                                            <div
                                                                class="flex cursor-pointer flex-col truncate rounded-md px-1.5 py-1 text-[10px] font-medium text-white transition-all hover:opacity-90"
                                                                [class]="
                                                                    getStatusColor(
                                                                        event.status
                                                                    )
                                                                "
                                                                (click)="
                                                                    openEvent(
                                                                        event
                                                                    );
                                                                    $event.stopPropagation()
                                                                "
                                                            >
                                                                <span
                                                                    class="truncate"
                                                                    >{{
                                                                        event.treatment
                                                                    }}</span
                                                                >
                                                            </div>
                                                        }
                                                    }
                                                </div>
                                                @if (
                                                    getEventsByMonth(day)
                                                        .length > 2
                                                ) {
                                                    <div
                                                        (click)="
                                                            openMoreEvents(day);
                                                            $event.stopPropagation()
                                                        "
                                                        class="mt-auto cursor-pointer rounded py-0.5 text-center text-[10px] font-medium text-blue-600 transition-colors hover:bg-blue-50 hover:text-blue-800"
                                                    >
                                                        +{{
                                                            getEventsByMonth(
                                                                day
                                                            ).length - 2
                                                        }}
                                                        más
                                                    </div>
                                                }

                                                <div
                                                    *ngIf="
                                                        showMore &&
                                                        moreDay === day
                                                    "
                                                    class="absolute inset-0 z-50 flex items-center justify-center"
                                                >
                                                    <div
                                                        class="fixed inset-0 z-40 bg-black/20"
                                                        (click)="
                                                            closeMore();
                                                            $event.stopPropagation()
                                                        "
                                                    ></div>
                                                    <div
                                                        class="animate-in fade-in zoom-in relative z-50 w-64 rounded-xl border border-gray-200 bg-white p-4 shadow-xl duration-200"
                                                        (click)="
                                                            $event.stopPropagation()
                                                        "
                                                    >
                                                        <div
                                                            class="mb-4 flex items-center justify-between border-b border-gray-100 pb-2"
                                                        >
                                                            <div
                                                                class="flex flex-col"
                                                            >
                                                                <span
                                                                    class="text-xs font-medium uppercase text-gray-500"
                                                                    >{{
                                                                        getDayHeader(
                                                                            currentDate.getFullYear(),
                                                                            currentDate.getMonth(),
                                                                            day +
                                                                                1
                                                                        )
                                                                    }}</span
                                                                >
                                                                <span
                                                                    class="text-2xl font-bold text-gray-900"
                                                                    >{{
                                                                        day
                                                                    }}</span
                                                                >
                                                            </div>

                                                            <button
                                                                mat-icon-button
                                                                (click)="
                                                                    closeMore();
                                                                    $event.stopPropagation()
                                                                "
                                                                class="flex h-8 w-8 items-center justify-center rounded-full text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600"
                                                                type="button"
                                                            >
                                                                <mat-icon
                                                                    svgIcon="feather:x"
                                                                    class="icon-size-4"
                                                                />
                                                            </button>
                                                        </div>

                                                        <div
                                                            class="custom-scrollbar max-h-60 space-y-1.5 overflow-y-auto pr-1"
                                                        >
                                                            @for (
                                                                event of getEventsByMonth(
                                                                    day
                                                                );
                                                                track $index
                                                            ) {
                                                                <div
                                                                    class="flex cursor-pointer flex-col rounded-md p-2 text-xs text-white shadow-sm transition-all hover:shadow-md"
                                                                    [class]="
                                                                        getStatusColor(
                                                                            event.status
                                                                        )
                                                                    "
                                                                    (click)="
                                                                        openEvent(
                                                                            event
                                                                        );
                                                                        $event.stopPropagation()
                                                                    "
                                                                >
                                                                    <div
                                                                        class="truncate font-bold"
                                                                    >
                                                                        {{
                                                                            event.treatment
                                                                        }}
                                                                    </div>
                                                                    <div
                                                                        class="mt-0.5 flex items-center gap-1 text-[10px] opacity-90"
                                                                    >
                                                                        <mat-icon
                                                                            svgIcon="feather:clock"
                                                                            class="icon-size-3 text-white"
                                                                        />
                                                                        {{
                                                                            event.start_time
                                                                                | date
                                                                                    : 'hh:mm a'
                                                                        }}
                                                                        -
                                                                        {{
                                                                            event.end_time
                                                                                | date
                                                                                    : 'hh:mm a'
                                                                        }}
                                                                    </div>
                                                                    <div
                                                                        class="mt-1 inline-block truncate rounded bg-black/10 px-1.5 py-0.5 text-[10px]"
                                                                    >
                                                                        Pcte:
                                                                        {{
                                                                            event
                                                                                .patient
                                                                                .name
                                                                        }}
                                                                    </div>
                                                                </div>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
                
            </div>
        </div>
    </div>
</div>

@if (selectedEvent) {
    <!-- backdrop-blur-sm -->
    <div class="fixed inset-0 z-50 flex justify-end  " 
         @slideInOut 
         (click)="closeSelectedEvent()">
        
        <app-modal-evento-sidebar
            class="sidebar-panel w-160 h-full" 
            [selectedEvent]="selectedEvent"
            (isClosed)="closeSelectedEvent()"
            (changedEvent)="getAppointments()"
            (editEvent)="startEditEvent($event)"
            (click)="$event.stopPropagation()"
        />
    </div>
}

<!-- @if (selectedEvent) {
                    <div class="relative z-50" @slideInOut>
                    <app-modal-evento-sidebar
                            [selectedEvent]="selectedEvent"
                            (isClosed)="selectedEvent = null"
                            (changedEvent)="getAppointments()"
                            (editEvent)="startEditEvent($event)"
                        />
                    </div>
                  
                    
                       
                   
                } -->

                @if (editingEvent) {
                    <modal-evento
                        [selectedEvent]="editingEvent"
                        (isClosed)="editingEvent = null"
                        (changedEvent)="editingEvent = null; getAppointments()"
                    />
                }

                @if (registerEvent && dentist) {
                    <!-- <modal-registro
                        [selectedDate]="selectedDate"
                        [dentist]="dentist"
                        (isClosed)="selectedDate = null"
                    /> -->
                    <div class="fixed inset-0 z-50 flex justify-end  " 
         @slideInOut 
         (click)="closeSelectedEvent()">
                     <sidebar-registro [selectedDate]="selectedDate"
                      class="sidebar-panel w-160 h-full" 
                        [dentist]="dentist"
                        (isClosed)="closeRegisterSidebar()"
                        (appointmentCreated)="handleAppointmentCreated()"></sidebar-registro> 
                         </div>
                }

                @if (eventPending) {
                    <modal-detalle
                        [appointment]="eventPending"
                        (isClosed)="eventPending = null"
                    />
                }

<!-- 
 <mat-drawer-container class="relative min-h-screen w-full overflow-hidden bg-slate-50">
    <mat-drawer [class]="wSidebar" [mode]="'over'" [opened]="false" [position]="'end'" [disableClose]="true" #matDrawer>
         @if (selectedEvent) {
                   
                        <app-modal-evento-sidebar
                            [selectedEvent]="selectedEvent"
                          (isClosed)="closeDrawer($event)"
                            (changedEvent)="getAppointments()"
                            (editEvent)="startEditEvent($event)"
                        />
                    
                }
    </mat-drawer>
    <mat-drawer-content class="relative flex h-full w-full items-start pb-4 pt-1">

    </mat-drawer-content>
 </mat-drawer-container> -->

  <!--   (isClosed)="closeDrawer($event)"  (isExpandedSidebar)="mostrarSubSidebar($event)" -->